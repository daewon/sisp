<html>
<head>


<script type="text/javascript" src="/static/js/analytics.js"></script>
<script type="text/javascript">archive_analytics.values.server_name="wwwb-app34.us.archive.org";archive_analytics.values.server_ms=3142;</script>
<link type="text/css" rel="stylesheet" href="/static/css/banner-styles.css"/>


<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<link rel="stylesheet" type="text/css" href="style.css" />
<title>Chapter 2: Data</title>
</head>
<body>


<!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript">//<![CDATA[
var __wm = (function(imgWidth,imgHeight,yearImgWidth,monthImgWidth){
var wbPrefix = "/web/";
var wbCurrentUrl = "http://www.lwh.jp/lisp/data.html";

var firstYear = 1996;
var displayDay = "12";
var displayMonth = "Oct";
var displayYear = "2014";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
var $D=document,$=function(n){return document.getElementById(n)};
var trackerVal,curYear = -1,curMonth = -1;
var yearTracker,monthTracker;
function showTrackers(val) {
  if (val===trackerVal) return;
  var $ipp=$("wm-ipp");
  var $y=$("displayYearEl"),$m=$("displayMonthEl"),$d=$("displayDayEl");
  if (val) {
    $ipp.className="hi";
  } else {
    $ipp.className="";
    $y.innerHTML=displayYear;$m.innerHTML=displayMonth;$d.innerHTML=displayDay;
  }
  yearTracker.style.display=val?"inline":"none";
  monthTracker.style.display=val?"inline":"none";
  trackerVal = val;
}
function trackMouseMove(event,element) {
  var eventX = getEventX(event);
  var elementX = getElementX(element);
  var xOff = Math.min(Math.max(0, eventX - elementX),imgWidth);
  var monthOff = xOff % yearImgWidth;

  var year = Math.floor(xOff / yearImgWidth);
  var monthOfYear = Math.min(11,Math.floor(monthOff / monthImgWidth));
  // 1 extra border pixel at the left edge of the year:
  var month = (year * 12) + monthOfYear;
  var day = monthOff % 2==1?15:1;
  var dateString = zeroPad(year + firstYear) + zeroPad(monthOfYear+1,2) +
    zeroPad(day,2) + "000000";

  $("displayYearEl").innerHTML=year+firstYear;
  $("displayMonthEl").innerHTML=prettyMonths[monthOfYear];
  // looks too jarring when it changes..
  //$("displayDayEl").innerHTML=zeroPad(day,2);
  var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
  $("wm-graph-anchor").href=url;

  if(curYear != year) {
    var yrOff = year * yearImgWidth;
    yearTracker.style.left = yrOff + "px";
    curYear = year;
  }
  if(curMonth != month) {
    var mtOff = year + (month * monthImgWidth) + 1;
    monthTracker.style.left = mtOff + "px";
    curMonth = month;
  }
}
function hideToolbar() {
  $("wm-ipp").style.display="none";
}
function bootstrap() {
  var $spk=$("wm-ipp-sparkline");
  yearTracker=$D.createElement('div');
  yearTracker.className='yt';
  with(yearTracker.style){
    display='none';width=yearImgWidth+"px";height=imgHeight+"px";
  }
  monthTracker=$D.createElement('div');
  monthTracker.className='mt';
  with(monthTracker.style){
    display='none';width=monthImgWidth+"px";height=imgHeight+"px";
  }
  $spk.appendChild(yearTracker);
  $spk.appendChild(monthTracker);

  var $ipp=$("wm-ipp");
  $ipp&&disclaimElement($ipp);
}
return{st:showTrackers,mv:trackMouseMove,h:hideToolbar,bt:bootstrap};
})(525, 27, 25, 2);//]]>
</script>
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  min-width:800px !important;
}
</style>
<div id="wm-ipp" lang="en" style="display:none;">

<div style="position:fixed;left:0;top:0;width:100%!important">
<div id="wm-ipp-inside">
   <table style="width:100%;"><tbody><tr>
   <td id="wm-logo">
       <a href="/web/" title="Wayback Machine home page"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0" /></a>
   </td>
   <td class="c">
       <table style="margin:0 auto;"><tbody><tr>
       <td class="u" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb"><input type="text" name="url" id="wmtbURL" value="http://www.lwh.jp/lisp/data.html" style="width:400px;" onfocus="this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20141012145146" /><input type="submit" value="Go" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td class="n" rowspan="2">
           <table><tbody>
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr class="m">
           	<td class="b" nowrap="nowrap">
		
		    <a href="/web/20130625202849/http://www.lwh.jp/lisp/data.html" title="25 Jun 2013">JUN</a>
		
		</td>
		<td class="c" id="displayMonthEl" title="You are here: 14:51:46 Oct 12, 2014">OCT</td>
		<td class="f" nowrap="nowrap">
		
		    Nov
		
                </td>
	    </tr>
           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr class="d">
               <td class="b" nowrap="nowrap">
               
                   <a href="/web/20130625202849/http://www.lwh.jp/lisp/data.html" title="20:28:49 Jun 25, 2013"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
               
               </td>
               <td class="c" id="displayDayEl" style="width:34px;font-size:24px;" title="You are here: 14:51:46 Oct 12, 2014">12</td>
	       <td class="f" nowrap="nowrap">
               
                   <img src="/static/images/toolbar/wm_tb_nxt_off.png" alt="Next capture" width="14" height="16" border="0"/>
               
	       </td>
           </tr>
           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr class="y">
	       <td class="b" nowrap="nowrap">
               
                   <a href="/web/20130625202849/http://www.lwh.jp/lisp/data.html" title="25 Jun 2013"><strong>2013</strong></a>
               
               </td>
               <td class="c" id="displayYearEl" title="You are here: 14:51:46 Oct 12, 2014">2014</td>
	       <td class="f" nowrap="nowrap">
               
                   2015
               
	       </td>
           </tr>
           </tbody></table>
       </td>
       </tr>
       <tr>
       <td class="s">
           <a class="t" href="/web/20141012145146*/http://www.lwh.jp/lisp/data.html" title="See a list of every capture for this URL">3 captures</a>
           <div class="r" title="Timespan for captures of this URL">27 May 13 - 12 Oct 14</div>
       </td>
       <td class="k">
       <a href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" title="Explore captures for this URL">
	 <img id="sparklineImgId" alt="sparklines"
		 onmouseover="__wm.st(1)" onmouseout="__wm.st(0)"
		 onmousemove="__wm.mv(event,this)"
		 width="525"
		 height="27"
		 border="0"
		 src="/web/jsp/graph.jsp?graphdata=525_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000000000000_2007:-1:000000000000_2008:-1:000000000000_2009:-1:000000000000_2010:-1:000000000000_2011:-1:000000000000_2012:-1:000000000000_2013:-1:000011000000_2014:9:000000000100_2015:-1:000000000000_2016:-1:000000000000" />
       </div>
       </a>
       </td>
       </tr></tbody></table>
   </td>
   <td class="r">
       <a href="#close" onclick="__wm.h();return false;" style="background-image:url(/static/images/toolbar/wm_tb_close.png);top:5px;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="background-image:url(/static/images/toolbar/wm_tb_help.png);bottom:5px;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>
</div>
</div>
</div>
<script type="text/javascript">__wm.bt();</script>
<!-- END WAYBACK TOOLBAR INSERT -->


<h1>Data</h1>

<p>
We will define four kinds of object to begin with:
<dl>
 <dt>Integer</dt>
 <dd>A number. For example: 3, -9, 0.</dd>
 <dt>Symbol</dt>
 <dd>A name consisting of a string of characters. For
  example: <code>FOO</code>, <code>BAR</code>, <code>ADD-TWO</code>.
  We will normalize characters to upper-case in this project, but this
  is not strictly necessary.</dd>
 <dt><code>NIL</code></dt>
 <dd>Represents "nothing". A bit like <code>NULL</code> in C and other
  languages.</dd>
 <dt>Pair</dt>
 <dd>A pair consists of two elements, which for historical reasons are
  called <i>car</i> and <i>cdr</i>. Both can hold either an integer, a
  symbol, <code>NIL</code>, or a <em>reference</em> to another pair.
  The types of each element may be different.</dd>
</dl>
Integers, symbols and <code>NIL</code> are called <i>simple data</i>.
The term <i>atom</i> can refer to either a simple datum or a pair
(purists may disagree on this point).
</p>

<p>
Note that integers and symbols are <em>immutable</em>, so we can think
of two integers with the same value as being the same object. This is
particularly useful for symbols, because it allows us to test for
equality by comparing pointers.
</p>

<h4>Implementation</h4>

<p>
Let's declare some C types to hold our data. There are many clever ways
to store LISP objects efficiently, but for this implementation we will
stick to a very simple scheme <small>[please excuse the pun]</small>.
</p>

<pre class="c">
struct Atom {
	enum {
		AtomType_Nil,
		AtomType_Pair,
		AtomType_Symbol,
		AtomType_Integer
	} type;

	union {
		struct Pair *pair;
		const char *symbol;
		long integer;
	} value;
};

struct Pair {
	struct Atom atom[2];
};

typedef struct Atom Atom;
</pre>

<p>
A few macros will be handy:
<pre class="c">
#define car(p) ((p).value.pair-&gt;atom[0])
#define cdr(p) ((p).value.pair-&gt;atom[1])
#define nilp(atom) ((atom).type == AtomType_Nil)

static const Atom nil = { AtomType_Nil };
</pre>
The "p" in <code>nilp</code> stands for "predicate". Identifiers in C
may not contain question marks. There is no need to restrict our LISP
implementation in that way, of course.
</p>

<p>
Integers and (pointers to) strings can be copied around, but we need to
allocate pairs on the heap.
<pre class="c">
Atom cons(Atom car_val, Atom cdr_val)
{
	Atom p;

	p.type = AtomType_Pair;
	p.value.pair = malloc(sizeof(struct Pair));

	car(p) = car_val;
	cdr(p) = cdr_val;

	return p;
}
</pre>
<code>cons</code> is a function to allocate a pair on the heap and
assign its two elements.
</p>

<p>
At this point you will have noticed that using <code>cons</code> will
leak memory the moment its return value is discarded. We will deal with
that later. Of course, if you are using a garbage-collected language
then the problem is already taken care of.
</p>

<h4>Testing</h4>

<p>
Now we can start creating LISP objects. An integer:
<pre class="c">
Atom make_int(long x)
{
	Atom a;
	a.type = AtomType_Integer;
	a.value.integer = x;
	return a;
}
</pre>
And a symbol:
<pre class="c">
Atom make_sym(const char *s)
{
	Atom a;
	a.type = AtomType_Symbol;
	a.value.symbol = strdup(s);
	return a;
}
</pre>
</p>

<h2>Textual representation</h2>

<p>
We will write a pair like this:
<pre class="lisp">(a . b)</pre>
where <code>a</code> is the <i>car</i> and <code>b</code> is the
<i>cdr</i>.
</p>

<p>
By using the <i>cdr</i> of a pair to reference another pair, we can
create a chain:
<pre class="lisp">
(a . (b . (c . (d . NIL))))
</pre>
Notice that the <i>cdr</i> of the last pair is <code>NIL</code>. This
signifies the end of the chain, and we call this structure a
<em>list</em>. To avoid having to write a large number of brackets, we
will write the previous list like this:
<pre class="lisp">(a b c d)</pre>
Finally, if the <i>cdr</i> of the last pair in a list is not
<code>NIL</code>, we will write this:
<pre class="lisp">(p q . r)</pre>
which is equivalent to
<pre class="lisp">(p . (q . r))</pre>
This is called an <i>improper list</i>.
</p>

<h4>Implementation</h4>

<p>
Printing an atom or list is simple.
<pre class="c">
void print_expr(Atom atom)
{
	switch (atom.type) {
	case AtomType_Nil:
		printf("NIL");
		break;
	case AtomType_Pair:
		putchar('(');
		print_expr(car(atom));
		atom = cdr(atom);
		while (!nilp(atom)) {
			if (atom.type == AtomType_Pair) {
				putchar(' ');
				print_expr(car(atom));
				atom = cdr(atom);
			} else {
				printf(" . ");
				print_expr(atom);
				break;
			}
		}
		putchar(')');
		break;
	case AtomType_Symbol:
		printf("%s", atom.value.symbol);
		break;
	case AtomType_Integer:
		printf("%ld", atom.value.integer);
		break;
	}
}
</pre>
By using recursion we can print aribtrarily complex data structures.
(Actually that's not true: for a very deeply nested structure we will
run out of stack space, and a self-referencing tree will never finish
printing).
</p>

<h4>Testing</h4>

<p>
See what <code>print_expr</code> does with various atoms:
<table border="1">
 <tr><th>Atom</th><th>Output</th></tr>
 <tr><td><code>make_int(42)</code><td><code>42</code></td>
 <tr><td><code>make_sym("FOO")</code><td><code>FOO</code></td>
 <tr><td><code>cons(make_sym("X"), make_sym("Y"))</code><td><code>(X . Y)</code></td>
 <tr><td><code>cons(make_int(1),<br />
   &nbsp;&nbsp;cons(make_int(2),<br />
   &nbsp;&nbsp;cons(make_int(3),<br />
   &nbsp;&nbsp;nil)))</code><td><code>(1 2 3)</code></td>
</table>
</p>

<p>
All this is pretty trivial. We'll get on to some more interesting stuff
in the next chapter.
</p>

<h3>One last thing</h3>

<p>
Remember we said that we would treat identical symbols as being the
same object? We can enforce that by keeping track of all the symbols
created, and returning the same atom if the same sequence of characters
is requested subsequently.
</p>

<p>
Languages with a set or hashtable container make this easy, but we can
use the LISP data structures already implemented to store the symbols
in a list:
<pre class="c">
static Atom sym_table = { AtomType_Nil };

Atom make_sym(const char *s)
{
	Atom a, p;

	p = sym_table;
	while (!nilp(p)) {
		a = car(p);
		if (strcmp(a.value.symbol, s) == 0)
			return a;
		p = cdr(p);
	}

	a.type = AtomType_Symbol;
	a.value.symbol = strdup(s);
	sym_table = cons(a, sym_table);

	return a;
}
</pre>
Neat, huh? It's not particularly efficient, but it will do fine for now.
</p>

</body>
</html>






<!--
     FILE ARCHIVED ON 14:51:46 Oct 12, 2014 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 16:28:50 Jan 20, 2016.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
